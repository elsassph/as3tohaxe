-- Parse the tokens generated by Lexer

module ActionhaXe.Parser where

import ActionhaXe.Lexer
import ActionhaXe.Prim
import Text.Parsec
import Text.Parsec.Combinator

type Semi = Maybe CToken

data BlockItem =  Tok        CToken
                | Block      CToken [BlockItem] CToken
                | ImportDecl CToken CToken Semi
    deriving (Show)

data Ast = Program Package AsState
    deriving (Show)

data Package = Package CToken (Maybe CToken) BlockItem
    deriving (Show)

program :: AsParser Ast
program = do{ x <- package; a <- getState; return $ Program x a}

package = do{ p <- kw "package"; i <- optionMaybe(ident); b <- block; return $ Package p i b }

block = do{ l <- op "{"; enterScope; x <- inBlock; r <- op "}"; exitScope; return $ Block l x r }

inBlock = try(do{ lookAhead( op "}"); return [] })
      <|> try(do{ b <- block; i <- inBlock; return $ [b] ++ i })
      <|> try(do{ x <- importDecl; i <- inBlock; return $ [x] ++ i})
      <|> try(do{ x <- anytok; i <- inBlock; return $ [(Tok x)] ++ i})

importDecl = do{ k <- kw "import"; s <- sident; o <- maybeSemi; return $ ImportDecl k s o}

parseTokens :: String -> [Token] -> Either ParseError Ast
parseTokens filename ts = runParser program initState filename ts
